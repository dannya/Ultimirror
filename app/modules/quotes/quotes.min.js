const request=require("request"),Promise=require("promise"),UltimirrorModule=require(ultimirror.path(["js","ultimirror","module.js"])),Quotes=UltimirrorModule.extend("Quotes",{moduleType:"quotes",moduleName:"Quotes",update:900,defaultConfig:[{id:"firstName",name:"First name",initial:"<system>",values:{"<system>":"(Use system setting)"}},{id:"lastName",name:"Last name",initial:"<system>",values:{"<system>":"(Use system setting)"}},{id:"maxLength",name:"Max length (chars)",initial:350}],_dataSources:[{url:"http://quotesondesign.com/wp-json/posts?filter[orderby]=rand&filter[posts_per_page]=1",fn:function(t){try{return{text:t[0].content,author:t[0].title}}catch(e){return{text:""}}}},{url:"http://quotes.rest/qod.json",fn:function(t){try{return{text:t.contents.quotes[0].quote}}catch(e){return{text:""}}}},{url:"http://api.icndb.com/jokes/random",fn:function(t){try{return{text:t.value.joke}}catch(e){return{text:""}}}},{url:function(){return"http://api.icndb.com/jokes/random?firstName="+self.config.firstName+"&lastName="+self.config.lastName},fn:function(t){try{return{text:t.value.joke}}catch(e){return{text:""}}}}],getData:function(){var t=this;t.loading(!0);var e=0,o=function(r,n){++e;var s=t._dataSources[Math.floor(3*Math.random())],a=s.url;"function"==typeof s.url&&(a=s.url()),request(a,function(a,u,i){if(a)t.loading(!1),n(n);else if(200===u.statusCode){var l=s.fn(JSON.parse(i));t.loading(!1),console.log("success for "+t.moduleType),r({text:l.text.length<t.config.maxLength?l.text:""})}else 429===u.statusCode?2>e?(console.log("-- trying "+t.moduleType+" again ("+e+" of 2) in 3 seconds"),setTimeout(function(){o(r,n)},3e3)):(console.error("-- too many "+t.moduleType+" attempts"),t.loading(!1),n(a)):(console.error(u.statusCode),console.error(a),t.loading(!1),n(a))})};return new Promise(o)}});module.exports=Quotes;