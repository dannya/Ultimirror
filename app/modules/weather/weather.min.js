const moment=require("moment"),request=require("request"),Promise=require("promise"),UltimirrorModule=require(ultimirror.path(["js","ultimirror","module.js"])),Weather=UltimirrorModule.extend("Weather",{moduleType:"weather",moduleName:"Weather",update:900,defaultConfig:[{id:"temperatureUnits",name:"Temperature units",initial:"<system>",values:{"<system>":"(Use system setting)",metric:"Metric",imperial:"Imperial"}},{id:"location",name:"Location",initial:"Birmingham,uk"},{id:"showLocation",name:"Show location?",initial:!0},{id:"apiKey",name:"OpenWeatherMap API key",initial:"41a4c2a6b97a096c0502d39a1326e028",note:"Go to TODO to get an API key for this service."},{id:"layout",name:"Layout",initial:"current_hybrid",values:{current:"Current forecast",current_hybrid:"Current forecast with 4 day (tabular) forecast","5day_table":"5 day forecast (tabular)"}}],getData:function(){var e=this;e.loading(!0);var t=0,i=function(r,a){++t,request("http://api.openweathermap.org/data/2.5/forecast?q="+e.config.location+"&units="+e.config.temperatureUnits+"&appid="+e.config.apiKey,function(o,n,s){if(o)e.loading(!1),a(o);else if(200===n.statusCode){var m=JSON.parse(s),u=e._extractWeather(m.list[0]),l=[];for(var c in m.list){var d=e._extractWeather(m.list[c]);12===d.timestamp.hour()&&l.push(d)}e.loading(!1),console.log("success for "+e.moduleType+" ("+e.config.location+")"),r({location:e.config.location.split(",")[0],current:u,days:l})}else 429===n.statusCode?2>t?(console.log("-- trying "+e.moduleType+" again ("+t+" of 2) in 3 seconds"),setTimeout(function(){i(r,a)},3e3)):(console.error("-- too many "+e.moduleType+" attempts"),e.loading(!1),a(o)):(console.error(n.statusCode),console.error(o),e.loading(!1),a(o))})};return new Promise(i)},_extractWeather:function(e){var t=moment.utc(1e3*parseInt(e.dt,10));return{timestamp:t,time:t.toISOString(),icon:e.weather[0].icon,condition:e.weather[0].main,temperature:e.main.temp,temperatureMin:e.main.temp_min,temperatureMax:e.main.temp_max,humidity:e.main.humidity,windSpeed:e.wind.speed}}});module.exports=Weather;