const fs=require("fs"),Class=require("class.extend"),Promise=require("promise"),UltimirrorModule=Class.extend("UltimirrorModule",{moduleType:"",moduleName:"",update:!1,defaultConfig:{},moduleId:"default",showLoading:!1,configLoaded:!1,dataLoaded:!1,_config:{},config:{},data:{},init:function(e){this.moduleId=e.moduleId,this.data={}},loading:function(e){this.showLoading=e,ipc.emit("updateModule",{moduleType:this.moduleType,moduleId:this.moduleId,attr:{showLoading:this.showLoading}})},modifyConfig:function(e,o){if(this.configLoaded){for(var i in e)this._config[i]=e[i],"true"===e[i]?e[i]=!0:"false"===e[i]&&(e[i]=!1),this.config[i]=e[i];var t=[];t="system"===this.moduleType?ultimirror.moduleInstances:[ultimirror.moduleInstances[this.moduleType+"_"+this.moduleId]],this._injectSystemValues(t).then(function(){ipc.emit("updateModule",{moduleType:this.moduleType,moduleId:this.moduleId,config:this.config})}),this._getData(),o===!0&&this._saveConfig()}},load:function(){var e=this,o=function(o){e._getData(),"number"==typeof e.update&&setInterval(e._getData.bind(e),1e3*e.update),o()};return new Promise(function(i,t){e.configLoaded?o(i,t):e._loadConfig().then(function(){e.configLoaded=!0,o(i,t)})})},_loadConfig:function(){var e=this;return new Promise(function(o){try{e._config=e._processConfig(require(ultimirror.path(["modules",e.moduleType,e.moduleType+".json"],!1))),e._config[e.moduleId]?(e._config=e._config[e.moduleId],console.log("--2"),console.log(e._config)):e._config=e._processConfig(e.defaultConfig)}catch(i){e._config=e._processConfig(e.defaultConfig)}e.config=JSON.parse(JSON.stringify(e._config)),e._config=e._idConfig(e._config),e.config=e._idConfig(e.config);var t=e.moduleType+"_"+e.moduleId;e._injectSystemValues([ultimirror.moduleInstances[t]]).then(function(){e.defaultConfig=e.defaultConfig,ipc.emit("updateModule",{moduleType:e.moduleType,moduleId:e.moduleId,config:e.config}),o()})})},_saveConfig:function(){console.log("--save--");var e;try{e=this._processConfig(require(ultimirror.path(["modules",this.moduleType,this.moduleType+".json"],!1)))}catch(o){e={}}e[this.moduleId]=JSON.parse(JSON.stringify(this._config)),e[this.moduleId]=this._idConfig(e[this.moduleId],!0);try{var i=JSON.stringify(e,function(e,o){return console.log(e+" - "+typeof o+" "+o),"true"===o?!0:"false"===o?!1:o},4),t=ultimirror.path(["modules",this.moduleType,this.moduleType+".json"],!1);fs.writeFileSync(t,i),console.info("config written to "+t),console.info(JSON.stringify(e,null,4))}catch(o){console.error(o)}},_idConfig:function(e,o){return o?(delete e.moduleType,delete e.moduleName,delete e.moduleId):(e.moduleType=this.moduleType,e.moduleName=this.moduleName,e.moduleId=this.moduleId),e},_getData:function(){if("function"!=typeof this.getData)return!1;var e=this;this.getData().then(function(o){e.dataLoaded=!0,ultimirror.fn.module.updateData({moduleType:e.moduleType,moduleId:e.moduleId},o)},function(o){console.error("Data load error: "+e.moduleType+"_"+e.moduleId),console.error(o)})},_processConfig:function(e){if("number"==typeof e.length){var o={};for(var i in e)o[e[i].id]=e[i].initial;return o}return e},_injectSystemValues:function(e){return new Promise(function(o){for(var i in e)if("system"!==e[i].moduleType){var t=!1;for(var n in e[i].config)"<system>"===e[i]._config[n]&&(t=!0,void 0!==ultimirror.moduleInstances.system_default.config[n]?e[i].config[n]=ultimirror.moduleInstances.system_default.config[n]:(console.warn(n+' not available in "system_default" config'),e[i].config[n]=""));t&&e[i].configLoaded&&e[i]._getData(),ipc.emit("updateModule",{moduleType:e[i].moduleType,moduleId:e[i].moduleId,config:e[i].config})}o()})}});module.exports=UltimirrorModule;